class Vulnerability < ApplicationRecord
end
class Vulnerability < ApplicationRecord

    belongs_to :check
  
    after_create :set_feedbacks_score
  
    WEAKNESS = {
      1 => 'Encryption of data not applied',
      2 => 'Various denial of service attacks',
      3 => 'Some allow remote code execution',
      4 => 'Ability to view data in transit',
      5 => 'Frequent vulnerabilities disclosed',
      6 => 'Attacker could view internal name space',
      7 => 'Can lead to access to drive share access',
      8 => 'Easy to misconfigure SNMP',
      9 => 'No confidentiality controls for man in middle atatcks',
      10 => 'Access to database from external',
      11 => 'Local access available to target system',
      12 => 'Encryption of data in transit not applied',
      13 => 'Can be used for volumetric attacks',
      14 => 'Vulnerabilities exist allowing remote code execution',
      15 => 'Can provide sensitive information, which accounts are running which service'
    }.freeze
  
    RISKS = {
      1 => 'Communications infiltration',
      2 => 'System or Network failure',
      3 => 'Unauthorised access to view data',
      4 => 'Unauthorised modification to data',
      5 => 'Unauthorised modification of data and system',
      6 => "Unauthorised ability to view data if attacker 'man in the middle'"
    }.freeze
  
    RECOMMANDATIONS = {
      1 => 'Ensure encryption in transit is applied',
      2 => 'Employ only if name server service is required',
      3 => 'Employ secure access control to this connection',
      4 => 'Ensure connection is redirected to encrypted trafic flow',
      5 => 'Ensure encryption is applied',
      6 => 'Ensure encrypted service is used',
      7 => 'Browsers still use port 80 as default so it is not recommended to close this port, ensure your' \
        'website redirects to HTTPS',
      8 => 'Leave open if  server to server mail server connections required. Consider enforcing encryption',
      9 => "If you don't use this service disable it"
    }.freeze
  
    def set_feedbacks_score
      if port == '20' || port == '21' || service == 'telnet'
        self.weakness = WEAKNESS[12]
        self.risk = RISKS[1]
        self.recommandation = RECOMMANDATIONS[5]
        self.impact = 2
        self.likelihood = 2
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '7'
        self.weakness = WEAKNESS[7]
        self.risk = RISKS[2]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 1
        self.likelihood = 1
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '9'
        self.weakness = WEAKNESS[7]
        self.risk = RISKS[2]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 1
        self.likelihood = 1
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '13'
        self.weakness = WEAKNESS[7]
        self.risk = RISKS[2]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 1
        self.likelihood = 1
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '19'
        self.weakness = WEAKNESS[7]
        self.risk = RISKS[2]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 1
        self.likelihood = 1
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '23'
        self.weakness = WEAKNESS[1]
        self.risk = RISKS[1]
        self.recommandation = RECOMMANDATIONS[1]
        self.impact = 1
        self.likelihood = 1
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '25' || service == 'smtp'
        self.weakness = WEAKNESS[1]
        self.risk = RISKS[1]
        self.recommandation = RECOMMANDATIONS[8]
        self.impact = 3
        self.likelihood = 2
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '37'
        self.weakness = WEAKNESS[7]
        self.risk = RISKS[2]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 1
        self.likelihood = 1
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '53' || service == 'dns'
        self.weakness = WEAKNESS[2]
        self.risk = RISKS[2]
        self.recommandation = RECOMMANDATIONS[2]
        self.impact = 3
        self.likelihood = 2
        self.netrisk = ((Math.sqrt(impact * likelihood) + 3) / 2) * 25
        save
  
      elsif port == '67' || service == 'dhcp'
        self.weakness = WEAKNESS[14]
        self.risk = RISKS[5]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 2
        self.likelihood = 2
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '69' || service == 'dhcp'
        self.weakness = WEAKNESS[1]
        self.risk = RISKS[1]
        self.recommandation = RECOMMANDATIONS[1]
        self.impact = 1
        self.likelihood = 1
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '80' || service == 'http'
        self.weakness = WEAKNESS[4]
        self.risk = RISKS[6]
        self.recommandation = RECOMMANDATIONS[7]
        self.impact = 1
        self.likelihood = 1
        self.netrisk = ((Math.sqrt(impact * likelihood) + 1) / 2) * 25
        save
  
      elsif port == '113'
        self.weakness = WEAKNESS[15]
        self.risk = RISKS[4]
        self.recommandation = RECOMMANDATIONS[9]
        self.impact = 1
        self.likelihood = 1
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '115'
        self.weakness = WEAKNESS[1]
        self.risk = RISKS[1]
        self.recommandation = RECOMMANDATIONS[1]
        self.impact = 1
        self.likelihood = 1
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '135' || service == 'epmap'
        self.weakness = WEAKNESS[5]
        self.risk = RISKS[5]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 4
        self.likelihood = 2
        self.netrisk = ((Math.sqrt(impact * likelihood) + 3) / 2) * 25
        save
  
      elsif port == '137' || service == 'netbios name service'
        self.weakness = WEAKNESS[6]
        self.risk = RISKS[3]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 3
        self.likelihood = 2
        self.netrisk = ((Math.sqrt(impact * likelihood) + 3) / 2) * 25
        save
  
      elsif port == '138' || service == 'netbios datagram service'
        self.weakness = WEAKNESS[7]
        self.risk = RISKS[4]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 4
        self.likelihood = 2
        self.netrisk = ((Math.sqrt(impact * likelihood) + 3) / 2) * 25
        save
  
      elsif port == '139' || service == 'netbios session service'
        self.weakness = WEAKNESS[7]
        self.risk = RISKS[4]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 4
        self.likelihood = 3
        self.netrisk = ((Math.sqrt(impact * likelihood) + 3) / 2) * 25
        save
  
      elsif port == '161' || service == 'snmp'
        self.weakness = WEAKNESS[8]
        self.risk = RISKS[5]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 4
        self.likelihood = 2
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '389' || service == 'ldap'
        self.weakness = WEAKNESS[9]
        self.risk = RISKS[4]
        self.recommandation = RECOMMANDATIONS[5]
        self.impact = 3
        self.likelihood = 2
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '445' || service == 'msds'
        self.weakness = WEAKNESS[7]
        self.risk = RISKS[5]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 4
        self.likelihood = 3
        self.netrisk = ((Math.sqrt(impact * likelihood) + 3) / 2) * 25
        save
  
      elsif port == '548' || service == 'afp'
        self.weakness = WEAKNESS[7]
        self.risk = RISKS[5]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 3
        self.likelihood = 1
        self.netrisk = ((Math.sqrt(impact * likelihood) + 2) / 2) * 25
        save
  
      elsif port == '1433' || service == 'sql server'
        self.weakness = WEAKNESS[10]
        self.risk = RISKS[5]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 3
        self.likelihood = 3
        self.netrisk = ((Math.sqrt(impact * likelihood) + 3) / 2) * 25
        save
  
      elsif port == '3389' || service == 'windows remote desktop'
        self.weakness = WEAKNESS[11]
        self.risk = RISKS[5]
        self.recommandation = RECOMMANDATIONS[3]
        self.impact = 4
        self.likelihood = 2
        self.netrisk = ((Math.sqrt(impact * likelihood) + 3) / 2) * 25
        save
      else
        'No worries :)'
      end
    end
  
  end
  